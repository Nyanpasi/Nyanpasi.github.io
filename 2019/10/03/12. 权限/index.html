<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>12. 权限 Permissions | 紫秋的个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="权限与身份认证和限流一起决定一个请求是否应该被允许或是拒绝. 权限检查在视图函数主体运行之前进行, 只有检查通过才会执行函数体, 权限一般使用reuqest.user或者request.auth的信息来进行验证. rest-framework 中的权限应当始终指定为一个权限类的列表, 列表所有的权限对象必须都通过之后才被视为通过.任意权限类检查失败, 会抛出一个exceptions.Permiss">
<meta name="keywords" content="django-rest-framework中文文档">
<meta property="og:type" content="article">
<meta property="og:title" content="12. 权限 Permissions">
<meta property="og:url" content="http://yoursite.com/2019/10/03/12. 权限/index.html">
<meta property="og:site_name" content="紫秋的个人博客">
<meta property="og:description" content="权限与身份认证和限流一起决定一个请求是否应该被允许或是拒绝. 权限检查在视图函数主体运行之前进行, 只有检查通过才会执行函数体, 权限一般使用reuqest.user或者request.auth的信息来进行验证. rest-framework 中的权限应当始终指定为一个权限类的列表, 列表所有的权限对象必须都通过之后才被视为通过.任意权限类检查失败, 会抛出一个exceptions.Permiss">
<meta property="og:locale" content="zh">
<meta property="og:updated_time" content="2019-10-10T10:21:43.511Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="12. 权限 Permissions">
<meta name="twitter:description" content="权限与身份认证和限流一起决定一个请求是否应该被允许或是拒绝. 权限检查在视图函数主体运行之前进行, 只有检查通过才会执行函数体, 权限一般使用reuqest.user或者request.auth的信息来进行验证. rest-framework 中的权限应当始终指定为一个权限类的列表, 列表所有的权限对象必须都通过之后才被视为通过.任意权限类检查失败, 会抛出一个exceptions.Permiss">
  
    <link rel="alternate" href="/atom.xml" title="紫秋的个人博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">紫秋的个人博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">孤独患者自我拉扯</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-12. 权限" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/03/12. 权限/" class="article-date">
  <time datetime="2019-10-03T09:56:47.000Z" itemprop="datePublished">2019-10-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      12. 权限 Permissions
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>权限与身份认证和限流一起决定一个请求是否应该被允许或是拒绝.</p>
<p>权限检查在视图函数主体运行之前进行, 只有检查通过才会执行函数体, 权限一般使用<code>reuqest.user</code>或者<code>request.auth</code>的信息来进行验证.</p>
<p>rest-framework 中的权限应当始终指定为一个权限类的列表, 列表所有的权限对象必须<strong>都</strong>通过之后才被视为通过.任意权限类检查失败, 会抛出一个<code>exceptions.PermissionDenied</code>或<code>exceptions.NotAuthenticated</code>异常.</p>
<a id="more"></a>


<p>权限检查失败时, 响应的状态码为 <code>403 Forbidden</code> 或 <code>401 Unauthorized</code></p>
<ul>
<li>如果请求通过用户身份认证, 但权限不足, 会返回<code>403 Forbidden</code></li>
<li>如果请求未通过用户身份认证, 但身份认证类不使用<code>WWW-Authenticate</code>头时, 也会返回<code>403 Unauthorized</code></li>
<li>如果请求未通过用户身份认证, 且最先应用的身份认证类中使用<code>WWW-Authenticate</code>, 会返回<code>401 Unauthorized</code>, 并包含合适的<code>WWW-Authenticate</code>头.</li>
</ul>
<hr>
<h3 id="对象级别的权限"><a href="#对象级别的权限" class="headerlink" title="对象级别的权限"></a>对象级别的权限</h3><p>这里的对象一般指的是一个Model的实例, 即某一条数据记录.</p>
<p>对象级别的权限验证会在GenericAPIView及其子类的<code>get_object()</code>方法被调用时进行验证.</p>
<p>如果对象级别的权限验证未通过, 会抛出<code>exceptions.PermissionDenied</code>异常.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_object</span><span class="params">(self)</span>:</span></span><br><span class="line">    obj = get_object_or_404(self.get_queryset(), pk=self.kwargs[<span class="string">"pk"</span>])</span><br><span class="line">    self.check_object_permissions(self.request, obj)</span><br><span class="line">    <span class="keyword">return</span> obj</span><br></pre></td></tr></table></figure>

<p>在rest-framework所提供的所有权限验证类中, 并不直接提供对象级别的验证, 所有的该级别验证都需要通过重写<code>has_object_permission()</code>实现, 而rest-framework会自动使用该方法检查权限.</p>
<p>详情查阅<strong>自定义权限验证</strong>一节. </p>
<hr>
<h3 id="设置权限"><a href="#设置权限" class="headerlink" title="设置权限"></a>设置权限</h3><p>全局权限设置通过settings的<code>DEFAULT_PERMISSION_CLASSES</code>项进行设置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">'DEFAULT_PERMISSION_CLASSES'</span>: (</span><br><span class="line">        <span class="string">'rest_framework.permissions.IsAuthenticated'</span>, </span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者通过<code>permission_classes</code>属性为指定APIview进行设置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    permission_classes = (IsAuthenticated, )</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>在视图中指定permission_classes意味着忽略默认的权限验证类</p>
<p>另外, 每个权限项可以由多个权限类用<code>|</code>、<code>&amp;</code>、<code>~</code>来组合作为权限类列表中的一个对象.</p>
<p>示例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> BasePermission, IsAuthenticated, SAFE_METHODS</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadOnly</span><span class="params">(BasePermission)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_permission</span><span class="params">(self, request, view)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> request.method <span class="keyword">in</span> SAFE_METHODS</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    permission_classes = [IsAuthenticated|ReadOnly]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, format=None)</span>:</span></span><br><span class="line">        content = &#123;</span><br><span class="line">            <span class="string">'status'</span>: <span class="string">'request was permitted'</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Response(content)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="API参考"><a href="#API参考" class="headerlink" title="API参考"></a>API参考</h2><p>以下各项从<code>rest_framework.permissions</code>中导出</p>
<hr>
<h3 id="AllowAny"><a href="#AllowAny" class="headerlink" title="AllowAny:"></a>AllowAny:</h3><p>无论如何, 允许无限制访问</p>
<hr>
<h3 id="IsAuthenticated"><a href="#IsAuthenticated" class="headerlink" title="IsAuthenticated:"></a>IsAuthenticated:</h3><ol>
<li>身份认证通过, 允许任何访问.</li>
<li>身份认证未通过, 禁止任何访问.</li>
</ol>
<hr>
<h3 id="IsAdminUser"><a href="#IsAdminUser" class="headerlink" title="IsAdminUser"></a>IsAdminUser</h3><ol>
<li>用户的is_stuff == True, 允许任何访问</li>
<li>用户的is_stuff == False, 禁止任何访问</li>
</ol>
<hr>
<h3 id="IsAuthenticatedOrReadOnly"><a href="#IsAuthenticatedOrReadOnly" class="headerlink" title="IsAuthenticatedOrReadOnly"></a>IsAuthenticatedOrReadOnly</h3><ol>
<li>身份认证通过, 允许任何访问</li>
<li>身份认证未通过, 允许只读访问</li>
</ol>
<hr>
<h3 id="DjangoModelPermissions"><a href="#DjangoModelPermissions" class="headerlink" title="DjangoModelPermissions"></a>DjangoModelPermissions</h3><p>该权限与DjangoModelPermissions相关联, 对于用户不同方式的请求, 验证对应的django权限(Model级别的权限验证)</p>
<p>因为必须与模型相关联, 该权限类仅能应用于具有.queryset属性的视图, 且仅有<strong>通过身份认证</strong>的用户才有可能通过权限验证</p>
<ul>
<li><code>POST</code> 请求要求用户对模型具有添加权限。</li>
<li><code>PUT</code> 和 <code>PATCH</code> 请求要求用户对模型具有更改权限。</li>
<li><code>DELETE</code>请求要求用户对模型具有删除权限。</li>
</ul>
<p>如果为匿名用户, 则一定被禁止.</p>
<hr>
<h3 id="DjangoModelPermissionsOrAnonReadOnly"><a href="#DjangoModelPermissionsOrAnonReadOnly" class="headerlink" title="DjangoModelPermissionsOrAnonReadOnly"></a>DjangoModelPermissionsOrAnonReadOnly</h3><p>与前者类似, 但允许匿名用户拥有只读权限.</p>
<hr>
<h3 id="DjangoObjectPermissions"><a href="#DjangoObjectPermissions" class="headerlink" title="DjangoObjectPermissions"></a>DjangoObjectPermissions</h3><p>该类由<a href="https://github.com/rpkilby/django-rest-framework-guardian" target="_blank" rel="noopener">djangorestframework-guardian package</a>提供.</p>
<p>绑定于Django的对象级别的权限验证, 允许对每个对象的权限(Model的实例, 对象级别的权限验证)进行单独指定.</p>
<p>当然, Django默认不支持该功能, 因此需要添加一个支持对象级别权限的权限后端, 例如<code>django-guardian</code></p>
<p>与DjangoModelPermissions一样, 该权限只有在用户已通过身份认证, 且用于与HTTP METHOD相对应的对象级别权限时才会被通过.</p>
<hr>
<h2 id="自定义权限验证"><a href="#自定义权限验证" class="headerlink" title="自定义权限验证"></a>自定义权限验证</h2><p>子类化<code>BasePermission</code>并实现以下两个方法</p>
<ul>
<li><code>.has_permission(self, request, view)</code></li>
<li><code>.has_object_permission(self, request, view, obj)</code></li>
</ul>
<p>这两个方法都应当返回一个布尔型, <code>True</code>代表验证通过, <code>False</code>则代表验证未通过.</p>
<p>前者代表模型级别的权限验证, 后者则是对象级别的权限验证</p>
<p>对象级别的权限验证仅当<code>get_object()</code>被调用时进行检查, 且必须在模型级别的验证通过时才会进行到这一步.</p>
<p>在GenericAPIView的子类中会自动调用<code>check_object_permissions</code>, 而在APIView的子类中你必须手动调用这一方法.</p>
<p>只读操作的HTTP METHOD为<code>GET</code>, <code>OPTION</code>及<code>HEAD</code>, 包含在<code>permissions.SAFE_METHODS</code>中.</p>
<p>示例</p>
<p>使用权限类实现黑名单. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> permissions</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlacklistPermission</span><span class="params">(permissions.BasePermission)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Global permission check for blacklisted IPs.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_permission</span><span class="params">(self, request, view)</span>:</span></span><br><span class="line">        ip_addr = request.META[<span class="string">'REMOTE_ADDR'</span>]</span><br><span class="line">        blacklisted = Blacklist.objects.filter(ip_addr=ip_addr).exists()</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">not</span> blacklisted</span><br></pre></td></tr></table></figure>

<p>自定义权限类, 仅允许对象的拥有者进行修改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IsOwnerOrReadOnly</span><span class="params">(permissions.BasePermission)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Object-level permission to only allow owners of an object to edit it.</span></span><br><span class="line"><span class="string">    Assumes the model instance has an `owner` attribute.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_object_permission</span><span class="params">(self, request, view, obj)</span>:</span></span><br><span class="line">        <span class="comment"># Read permissions are allowed to any request, </span></span><br><span class="line">        <span class="comment"># so we'll always allow GET, HEAD or OPTIONS requests.</span></span><br><span class="line">        <span class="keyword">if</span> request.method <span class="keyword">in</span> permissions.SAFE_METHODS:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Instance must have an attribute named `owner`.</span></span><br><span class="line">        <span class="keyword">return</span> obj.owner == request.user</span><br></pre></td></tr></table></figure>

<p>值得注意的是, 在list操作中, 仅会进行模型级别的权限检查, 对象级别的权限不会被检查(只有在get_object方法被调用时才会进行对象级别的检查), 因此如果有必要, 则需要将其验证逻辑写入filter而非对象级别的权限中, 这样才能保证在get_queryset时获取到适当的queryset. </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/10/03/12. 权限/" data-id="ck1kjuhpz0001ngplw9d4ql12" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/django-rest-framework中文文档/">django-rest-framework中文文档</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/10/03/13. 缓存/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          13. 缓存 Cache
        
      </div>
    </a>
  
  
    <a href="/2019/10/03/10.2 序列化器字段-关系字段/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">10.2 序列化器字段:关系字段 Serializer Field</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL-数据库/">SQL 数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django-rest-framework中文文档/">django-rest-framework中文文档</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/元编程/">元编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端安全/">前端安全</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/SQL-数据库/" style="font-size: 10px;">SQL 数据库</a> <a href="/tags/django-rest-framework中文文档/" style="font-size: 20px;">django-rest-framework中文文档</a> <a href="/tags/元编程/" style="font-size: 10px;">元编程</a> <a href="/tags/前端安全/" style="font-size: 10px;">前端安全</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/10/03/26. 设置/">26. 设置 Settings</a>
          </li>
        
          <li>
            <a href="/2019/10/03/25. 测试/">25. 测试 Testing</a>
          </li>
        
          <li>
            <a href="/2019/10/03/24. 状态码/">24. 状态码 Status</a>
          </li>
        
          <li>
            <a href="/2019/10/03/23. 异常处理/">23. 异常处理 Exception</a>
          </li>
        
          <li>
            <a href="/2019/10/03/22. 返回URL/">22. 返回URL Return URL</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 紫秋<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>